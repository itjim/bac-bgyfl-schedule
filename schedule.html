<script>
  const proxyUrl = "https://taupe-meringue-d27509.netlify.app/.netlify/functions/proxy?url=";
  const gamesEndpoint = "https://slhjx7xcc1.execute-api.us-east-2.amazonaws.com/prod/api/getGames?year=2025";

  // Simple logo map (expand later dynamically from BGYFL)
  const logos = {
    "Bloomingdale": "http://bgyfl-website-new-prod.s3-website.us-east-2.amazonaws.com/assets/bloomingdale.png",
    "Naperville": "http://bgyfl-website-new-prod.s3-website.us-east-2.amazonaws.com/assets/naperville.png",
    "Elmhurst": "http://bgyfl-website-new-prod.s3-website.us-east-2.amazonaws.com/assets/elmhurst.png"
  };

  async function fetchData() {
    const response = await fetch(proxyUrl + encodeURIComponent(gamesEndpoint));
    const data = await response.json();
    return data.games || [];
  }

  function getDayOfWeek(dateStr) {
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    return days[new Date(dateStr).getDay()];
  }

  function renderSchedule(games, week) {
    const tbody = document.querySelector("#scheduleTable tbody");
    tbody.innerHTML = "";

    // Only Bloomingdale games (either home or away org contains Bloomingdale)
    const filtered = games.filter(g =>
      g.week === week &&
      (
        g.home_team?.organization_name?.includes("Bloomingdale") ||
        g.away_team?.organization_name?.includes("Bloomingdale")
      )
    );

    let currentDay = "";
    filtered.forEach(game => {
      const gameDate = game.game_date;
      const dayName = getDayOfWeek(gameDate);

      // Insert separator row for each day
      if (dayName !== currentDay) {
        currentDay = dayName;
        const row = document.createElement("tr");
        row.classList.add("day-separator");
        const cell = document.createElement("td");
        cell.colSpan = 7;
        cell.textContent = dayName;
        row.appendChild(cell);
        tbody.appendChild(row);
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${gameDate || ""}</td>
        <td>${dayName || ""}</td>
        <td>${game.game_time || ""}</td>
        <td class="team-cell">${renderTeam(game.home_team)}</td>
        <td class="team-cell">${renderTeam(game.away_team)}</td>
        <td>${game.field?.field_name || ""}</td>
        <td>${(game.home_score ?? "0")} - ${(game.away_score ?? "0")}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function renderTeam(teamObj) {
    if (!teamObj) return "TBD";
    const org = teamObj.organization_name || "";
    const team = teamObj.team_name || "";
    const displayName = `${org} ${team}`;
    const logo = logos[org] || "";
    return logo ? `<img src="${logo}" alt="${org} logo"/> ${displayName}` : displayName;
  }

  async function init() {
    const games = await fetchData();
    const weekSelect = document.getElementById("weekSelect");
    const weeks = [...new Set(games.map(g => g.week))].sort((a, b) => a - b);

    weeks.forEach(w => {
      const opt = document.createElement("option");
      opt.value = w;
      opt.textContent = `Week ${w}`;
      weekSelect.appendChild(opt);
    });

    weekSelect.addEventListener("change", () => {
      renderSchedule(games, parseInt(weekSelect.value));
    });

    if (weeks.length > 0) {
      weekSelect.value = weeks[0];
      renderSchedule(games, weeks[0]);
    }
  }

  init();
</script>
