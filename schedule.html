<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bloomingdale Bears Schedule</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #003366; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #003366; color: white; }
    .team-cell { display: flex; align-items: center; justify-content: center; gap: 6px; }
    .team-cell img { height: 24px; width: 24px; object-fit: contain; }
    select, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h1>Bloomingdale Bears Schedule</h1>
  
  <label for="weekSelect">Select Week:</label>
  <select id="weekSelect"></select>
  
  <label for="teamSelect">Select Team:</label>
  <select id="teamSelect"></select>
  
  <button id="toggleView">Show Bloomingdale Only</button>
  
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Home Team</th>
        <th>Away Team</th>
        <th>Field</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody id="scheduleBody"></tbody>
  </table>

  <script>
    const proxyUrl = "https://taupe-meringue-d27509.netlify.app/.netlify/functions/proxy?url=";
    const apiBase = "https://slhjx7xcc1.execute-api.us-east-2.amazonaws.com/prod/api";

    let teamLookup = {}; // orgId → { name, logo }
    let bloomTeams = []; // Bloomingdale-only
    let allGames = [];
    let bloomOnly = true;

    async function fetchTeams() {
      try {
        const res = await fetch("http://bgyfl-website-new-prod.s3-website.us-east-2.amazonaws.com/");
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        doc.querySelectorAll("a").forEach(link => {
          const url = link.getAttribute("href");
          if (url && url.includes("organizationId=")) {
            const orgId = new URL(url, res.url).searchParams.get("organizationId");
            const img = link.querySelector("img");
            const logo = img ? img.src : "";
            const text = link.innerText.trim().replace(/\s+/g, " ");
            teamLookup[orgId] = { name: text, logo: logo };
            if (text.toLowerCase().includes("bloomingdale")) {
              bloomTeams.push(orgId);
            }
          }
        });
      } catch (e) {
        console.error("Failed to fetch teams:", e);
      }
    }

    async function fetchGames() {
      const url = `${proxyUrl}${encodeURIComponent(apiBase + "/getGames?year=2025&organizationId=9")}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.success) {
        allGames = data.games;
      }
    }

    function buildWeekOptions() {
      const weekSelect = document.getElementById("weekSelect");
      const weeks = [...new Set(allGames.map(g => g.week))].sort((a,b) => a-b);
      weekSelect.innerHTML = "";
      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = `Week ${w} – ${allGames.find(g => g.week === w).game_date}`;
        weekSelect.appendChild(opt);
      });
      weekSelect.value = weeks[0];
    }

    function buildTeamOptions() {
      const teamSelect = document.getElementById("teamSelect");
      teamSelect.innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "All Bloomingdale Teams";
      teamSelect.appendChild(allOpt);

      bloomTeams.forEach(id => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = teamLookup[id]?.name || `Team ${id}`;
        teamSelect.appendChild(opt);
      });
    }

    function renderSchedule() {
      const tbody = document.getElementById("scheduleBody");
      tbody.innerHTML = "";

      const week = parseInt(document.getElementById("weekSelect").value);
      const teamFilter = document.getElementById("teamSelect").value;

      const games = allGames.filter(g => g.week === week);
      games.forEach(g => {
        const home = teamLookup[g.home_organization_id] || { name: "TBD", logo: "" };
        const away = teamLookup[g.away_organization_id] || { name: "TBD", logo: "" };

        if (bloomOnly) {
          if (teamFilter === "all") {
            if (!bloomTeams.includes(String(g.home_organization_id)) &&
                !bloomTeams.includes(String(g.away_organization_id))) return;
          } else if (![g.home_organization_id, g.away_organization_id].includes(parseInt(teamFilter))) {
            return;
          }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${g.game_date}</td>
          <td>${g.game_time}</td>
          <td class="team-cell">${home.logo ? `<img src="${home.logo}">` : ""} ${home.name}</td>
          <td class="team-cell">${away.logo ? `<img src="${away.logo}">` : ""} ${away.name}</td>
          <td>${g.field || ""}</td>
          <td>${g.home_score} - ${g.away_score}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("weekSelect").addEventListener("change", renderSchedule);
    document.getElementById("teamSelect").addEventListener("change", renderSchedule);
    document.getElementById("toggleView").addEventListener("click", () => {
      bloomOnly = !bloomOnly;
      document.getElementById("toggleView").textContent = bloomOnly ? "Show All BGYFL Games" : "Show Bloomingdale Only";
      renderSchedule();
    });

    (async function init() {
      await fetchTeams();
      await fetchGames();
      buildWeekOptions();
      buildTeamOptions();
      renderSchedule();
    })();
  </script>
</body>
</html>
