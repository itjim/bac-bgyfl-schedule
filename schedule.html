<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bloomingdale Bears Schedule</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #003366; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #003366; padding: 8px; text-align: center; }
    th { background-color: #003366; color: white; }
    .day-separator { background-color: #f2f2f2; font-weight: bold; text-align: left; }
    #debugPanel { 
      display: none; 
      margin-top: 20px; 
      padding: 10px; 
      border: 1px solid #ccc; 
      background: #fafafa; 
      white-space: pre-wrap; 
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
    }
    #debugToggle {
      margin-top: 15px;
      padding: 6px 12px;
      background: #003366;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Bloomingdale Bears Schedule</h1>

  <label for="weekSelect">Select Week:</label>
  <select id="weekSelect"></select>

  <table id="scheduleTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Day</th>
        <th>Time</th>
        <th>Home Team</th>
        <th>Away Team</th>
        <th>Field</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="debugToggle">Show Debug</button>
  <div id="debugPanel"></div>

  <script>
    const proxyUrl = "https://taupe-meringue-d27509.netlify.app/.netlify/functions/proxy?url=";
    const gamesEndpoint = "https://slhjx7xcc1.execute-api.us-east-2.amazonaws.com/prod/api/getGames?year=2025";

    let allGames = [];

    async function fetchData() {
      const response = await fetch(proxyUrl + encodeURIComponent(gamesEndpoint));
      const data = await response.json();
      console.log("API payload:", data);
      return data.games || [];
    }

    function getDayOfWeek(dateStr) {
      const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      return days[new Date(dateStr).getDay()];
    }

    function renderSchedule(games, week) {
      const tbody = document.querySelector("#scheduleTable tbody");
      tbody.innerHTML = "";

      const filtered = games.filter(g =>
        g.week === week &&
        (
          g.home_team?.organization_name?.includes("Bloomingdale") ||
          g.away_team?.organization_name?.includes("Bloomingdale")
        )
      );

      let currentDay = "";
      filtered.forEach(game => {
        const gameDate = game.game_date;
        const dayName = getDayOfWeek(gameDate);

        if (dayName !== currentDay) {
          currentDay = dayName;
          const row = document.createElement("tr");
          row.classList.add("day-separator");
          const cell = document.createElement("td");
          cell.colSpan = 7;
          cell.textContent = dayName;
          row.appendChild(cell);
          tbody.appendChild(row);
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${gameDate}</td>
          <td>${dayName}</td>
          <td>${game.game_time}</td>
          <td>${game.home_team?.organization_name || ""} ${game.home_team?.team_name || ""}</td>
          <td>${game.away_team?.organization_name || ""} ${game.away_team?.team_name || ""}</td>
          <td>${game.field?.field_name || ""}</td>
          <td>${(game.home_score ?? 0)} - ${(game.away_score ?? 0)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function init() {
      allGames = await fetchData();
      console.log("Games parsed:", allGames);

      // Populate debug panel
      document.getElementById("debugPanel").textContent = JSON.stringify(allGames, null, 2);

      const weekSelect = document.getElementById("weekSelect");
      const weeks = [...new Set(allGames.map(g => g.week))].sort((a, b) => a - b);

      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = `Week ${w}`;
        weekSelect.appendChild(opt);
      });

      weekSelect.addEventListener("change", () => {
        renderSchedule(allGames, parseInt(weekSelect.value));
      });

      if (weeks.length > 0) {
        weekSelect.value = weeks[0];
        renderSchedule(allGames, weeks[0]);
      }
    }

    // Debug toggle
    document.getElementById("debugToggle").addEventListener("click", () => {
      const panel = document.getElementById("debugPanel");
      if (panel.style.display === "none") {
        panel.style.display = "block";
        document.getElementById("debugToggle").textContent = "Hide Debug";
      } else {
        panel.style.display = "none";
        document.getElementById("debugToggle").textContent = "Show Debug";
      }
    });

    init();
  </script>
</body>
</html>
